{"version":3,"file":"index.esm.js","sources":["../lib/interceptors/csrf-token.ts","../lib/interceptors/maintenance-mode.ts","../lib/interceptors/not-logged-in.ts","../lib/index.ts"],"sourcesContent":["import { generateUrl } from '@nextcloud/router'\n\nconst RETRY_KEY = Symbol('csrf-retry')\n\nexport const onError = axios => async (error) => {\n\tconst { config, response, request } = error\n\tconst responseURL = request?.responseURL\n\tconst status = response?.status\n\n\tif (status === 412\n\t\t&& response?.data?.message === 'CSRF check failed'\n\t\t&& config[RETRY_KEY] === undefined) {\n\t\tconsole.warn(`Request to ${responseURL} failed because of a CSRF mismatch. Fetching a new token`)\n\n\t\tconst { data: { token } } = await axios.get(generateUrl('/csrftoken'))\n\t\tconsole.debug(`New request token ${token} fetched`)\n\t\taxios.defaults.headers.requesttoken = token\n\n\t\treturn axios({\n\t\t\t...config,\n\t\t\theaders: {\n\t\t\t\t...config.headers,\n\t\t\t\trequesttoken: token,\n\t\t\t},\n\t\t\t[RETRY_KEY]: true,\n\t\t})\n\t}\n\n\treturn Promise.reject(error)\n}\n","const RETRY_DELAY_KEY = Symbol('retryDelay')\n\nexport const onError = axios => async (error) => {\n\tconst { config, response, request } = error\n\tconst responseURL = request?.responseURL\n\tconst status = response?.status\n\tconst headers = response?.headers\n\n\t/**\n\t * Retry requests if they failed due to maintenance mode\n\t *\n\t * The delay is exponential. It starts at 2s and then doubles\n\t * until a final retry after 32s. This results in roughly 1m of\n\t * retries until we give up and throw the axios error towards\n\t * the caller.\n\t */\n\tif (status === 503\n\t\t&& headers['x-nextcloud-maintenance-mode'] === '1'\n\t\t&& config.retryIfMaintenanceMode\n\t\t&& (!config[RETRY_DELAY_KEY] || config[RETRY_DELAY_KEY] <= 32)) {\n\t\tconst retryDelay = (config[RETRY_DELAY_KEY] ?? 1) * 2\n\t\tconsole.warn(`Request to ${responseURL} failed because of maintenance mode. Retrying in ${retryDelay}s`)\n\t\tawait new Promise((resolve, _) => {\n\t\t\tsetTimeout(resolve, retryDelay*1000)\n\t\t})\n\n\t\treturn axios({\n\t\t\t...config,\n\t\t\t[RETRY_DELAY_KEY]: retryDelay,\n\t\t})\n\t}\n\n\treturn Promise.reject(error)\n}\n","export const onError = async (error) => {\n\tconst { config, response, request } = error\n\tconst responseURL = request?.responseURL\n\tconst status = response?.status\n\n\tif (status === 401\n\t\t&& response?.data?.message === 'Current user is not logged in'\n\t\t&& config.reloadExpiredSession\n\t\t&& window?.location) {\n\t\tconsole.error(`Request to ${responseURL} failed because the user session expired. Reloading the page â€¦`)\n\n\t\twindow.location.reload()\n\t}\n\n\treturn Promise.reject(error)\n}\n","import Axios, { AxiosInstance, CancelTokenStatic } from 'axios'\nimport { getRequestToken, onRequestTokenUpdate } from '@nextcloud/auth'\n\nimport { onError as onCsrfTokenError } from './interceptors/csrf-token'\nimport { onError as onMaintenanceModeError } from './interceptors/maintenance-mode'\nimport { onError as onNotLoggedInError } from './interceptors/not-logged-in'\n\ninterface CancelableAxiosInstance extends AxiosInstance {\n\tCancelToken: CancelTokenStatic\n\tisCancel(value: any): boolean\n}\n\nconst client: any = Axios.create({\n\theaders: {\n\t\trequesttoken: getRequestToken() ?? ''\n\t}\n})\nconst cancelableClient: CancelableAxiosInstance = Object.assign(client, {\n\tCancelToken: Axios.CancelToken,\n\tisCancel: Axios.isCancel,\n})\n\ncancelableClient.interceptors.response.use(r => r, onCsrfTokenError(cancelableClient))\ncancelableClient.interceptors.response.use(r => r, onMaintenanceModeError(cancelableClient))\ncancelableClient.interceptors.response.use(r => r, onNotLoggedInError)\n\nonRequestTokenUpdate(token => client.defaults.headers.requesttoken = token)\n\nexport default cancelableClient\n"],"names":["onError","onCsrfTokenError","onMaintenanceModeError","onNotLoggedInError"],"mappings":"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"}